<!DOCTYPE html>
<html lang="en">
<head>
    <title>Dash-Maps Editor</title>
    <link rel="shortcut icon" href="images/favicon.png">
    <link rel="stylesheet" type="text/css" href="css/html5reset-1.6.1.css" />
    <link rel="stylesheet" type="text/css" href="lib/Font-Awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="lib/jquery-dropdown/jquery.dropdown.css" />
    <link rel="stylesheet" type="text/css" href="css/map_editor.css" />
    <script type="text/javascript" src="lib/jquery-2.0.2.min.js"></script>
    <script type="text/javascript" src="lib/jquery-dropdown/jquery.dropdown.js"></script>
    <script type="text/javascript" src="lib/jquery.form.min.js"></script>
    <script type="text/javascript" src="lib/knockout-2.2.1.js"></script>
    <script type="text/javascript" src="lib/knockout.mapping/knockout.mapping.js"></script>
    <script type="text/javascript" src="js/utils.js"></script>
    <script type="text/javascript" src="js/map_editor.js"></script>
    <script type="text/javascript">
$(function(){
	var appl = window.appl = new Appl();
	appl.sheets_visible = ko.observable(false);
	appl.sprites_visible = ko.observable(false);
    appl.edit_layers = ko.observableArray();
    
    appl.selected_sheet.subscribe(function(sheet){
        if(sheet && sheet.sheet_width() === 0){
            var image_src = "images/spritesheets/" + sheet.sheet();
            var imageObj = new Image();
            imageObj.onload = function() {
                sheet.sheet_width(imageObj.width);
                sheet.sheet_height(imageObj.height);
            };
            imageObj.src = image_src;
        }
    });
	
	$('.sheets-tool').click(function(){
		appl.sheets_visible(!appl.sheets_visible());
	});
	$('.sprites-tool').click(function(){
		appl.sprites_visible(!appl.sprites_visible());
	});
	$("#map").click(function(e){
		var $map = $("#map");
		var posX = e.pageX - $map.offset().left,
			posY = e.pageY - $map.offset().top;
		appl.do_action(posX, posY);
	});
	
	var $container = $('#spitesheetgrid');
    var $selection = $('<div>').addClass('selection-box');
    var selection_border_width = 1;
    
    $container.on('mousedown', function(e) {
    	if(e.target !== $container[0]) return;
    	
        var click_y = e.pageY,
	    	click_x = e.pageX,
            move_x = 0,
            move_y = 0,
	    	width = 0,
	    	height = 0;
      
        $selection.css({
          'top':    appl.snap_to_grid(click_y - $container.offset().top),
          'left':   appl.snap_to_grid(click_x - $container.offset().left),
          'width':  0,
          'height': 0
        });
        $selection.appendTo($container);
        
        $container.on('mousemove', function(e) {            
          move_x = e.pageX;
          move_y = e.pageY;
          var new_x, new_y;

		      width  = appl.snap_to_grid(Math.abs(move_x - click_x)),
		      height = appl.snap_to_grid(Math.abs(move_y - click_y)),
          
          new_x = (move_x < click_x) ? (click_x - width) : click_x;
          new_y = (move_y < click_y) ? (click_y - height) : click_y;
          
          $selection.css({
            'width': width - selection_border_width,
            'height': height - selection_border_width,
            'top': appl.snap_to_grid(new_y - $container.offset().top),
            'left': appl.snap_to_grid(new_x - $container.offset().left)
          });
            
        }).on('mouseup', function(e) {
            $container.off('mousemove');
            $container.off('mouseup');
            var origin_x = click_x,
                origin_y = click_y;
            
            // determine origin from click or move
            if(move_y < click_y) {
                origin_y = move_y;
            }
            if(move_x < click_x){
                origin_x = move_x;
            }
            
            var dragged_rect = [
            	appl.snap_to_grid(origin_x - $container.offset().left) || 0,
            	appl.snap_to_grid(origin_y - $container.offset().top) || 0,
            	width,
            	height
            ];
            if(width >= appl.grid_size() && height >= appl.grid_size()){
                appl.sheet_drag_rect(dragged_rect);
            } else {
                appl.sheet_drag_rect(null);
                $selection.remove();
            }
        });
    });
    
    appl.__add_item__ = function(){
    	$selection.remove();
    	appl.add_spite_sheet_item();
    };
    
    appl.__remove_item__ = function(){
    	appl.delete_sprite_sheet_item();
    };
    
    appl.__sort_draw__ = function(l,r){
    	return l.layer() === r.layer() ? 0 : l.layer() > r.layer() ? 1 : -1;
    };
    
    appl.__layer_dialog__ = function(){
        this.edit_layers.removeAll();
        var layers = this._get_layer_names_();
        for(var i=0; i<layers.length;i++){
            this.edit_layers.push({
                title: ko.observable(layers[i]),
                origin: layers[i]
            });
        }
        $(".lyr-dialog-container").show();
    };
    
    appl.__upload_dialog__ = function(){
        $(".sps-dialog-container").show();
    };
    
    appl.__open_map__ = function(){
        
    };
    
    appl.__save_map__ = function(){
        $(".mps-dialog-container").show();
        $("input[type=text]",".mps-dialog-container").first().focus();
    };
    
    set_background_grid("#map",appl.grid_size(),"#ccc");
    set_background_grid("#spitesheetgrid",appl.grid_size(),"#ccc");
    
    $(".dialog-close",".sps-dialog-container").click(function(evt){
        $(".sps-dialog-container").hide();
        evt.preventDefault();
    });
    $('.dialog-content',".sps-dialog-container").ajaxForm(function(response) {
        $(".sps-dialog-container").hide();
        // add missing new sprite sheets
        var data = $.parseJSON(response);
        var new_sheets = data.diff(appl._get_sheet_names_());
        for(var i=0; i<new_sheets.length; i++){
            appl.add_sprite_sheet(new_sheets[i]);
        }
    });
    
    $(".dialog-close",".mps-dialog-container").click(function(evt){
        $(".mps-dialog-container").hide();
        evt.preventDefault();
    });
    $('.dialog-content',".mps-dialog-container").ajaxForm({beforeSubmit:function(formData, jqForm, options){
        $(".mps-dialog-container").hide();
        formData.push({name:'filedata',value:ko.mapping.toJSON(appl),type:'json',required:false});
        console.log(formData);
        return false;
    }});
    
    $(".dialog-close",".lyr-dialog-container").click(function(evt){
        $(".lyr-dialog-container").hide();
        evt.preventDefault();
        console.log("form closed");
    });
    $('.dialog-content',".lyr-dialog-container").ajaxForm({beforeSubmit:function(formData, jqForm, options){
        $(".lyr-dialog-container").hide();
        return false;
        console.log("form submitted");
    }});
    
    $.getJSON("/spritesheets", function(data, textStatus, jqXHR){
        data.sort();
        for(var i=0; i<data.length; i++){
            appl.add_sprite_sheet(data[i]);
        }  
        ko.applyBindings(appl);  
    });
});  
  </script>
</head>
<body>
	<div id="menu">
        <span class="logo">
            <i class="icon-gamepad"></i>
            Dash-Maps
        </span>
		<button class="paint-tool" data-bind="css:{'active':selected_tool()=='paint'},click:$.proxy(selected_tool,$root,'paint')">
            <i class="icon-pencil"></i>
            Paint
        </button>
		<button class="delete-tool" data-bind="css:{'active':selected_tool()=='delete'},click:$.proxy(selected_tool,$root,'delete')">
            <i class="icon-eraser"></i>
            Delete
        </button>
		<button class="sheets-tool pull-right" data-bind="css:{'active':sheets_visible}">
            <i class="icon-archive"></i>
            Sheets
        </button>
        <!-- ko if:selected_sheet -->
        <button class="sheet-tool pull-right" data-bind="visible:sheets_visible" 
                data-dropdown="#dropdown-sheets" data-horizontal-offset="6">
            <span data-bind="text:selected_sheet().sheet"></span>
            <i class="icon-caret-down"></i>
        </button>
        <!-- /ko -->
		<button class="add-sheetitem-tool pull-right" data-bind="visible:sheets_visible,enable:selected_sprite_item,click:__remove_item__">remove</button>
		<button class="add-sheetitem-tool pull-right" data-bind="visible:sheets_visible,enable:sheet_drag_rect,click:__add_item__">add</button>
		<button class="sprites-tool" data-bind="css:{'active':sprites_visible}">
            <i class="icon-picture"></i>
            Sprites
        </button>
        <div class="pull-right" style="margin-top: 5px; margin-right: 5px;" data-bind="visible:sheets_visible">Selection:<span data-bind="text:selected_sprite_item_index()"></span></div>
        
        <input class="layer-text" type="text" 
               data-bind="value:selected_layer"/><button class="layer-dropdown"
                      data-dropdown="#dropdown-layers" data-horizontal-offset="6">
            <i class="icon-caret-down"></i></button>
        
        <span style="margin-left: 6px;">w:</span>
        <input class="menu-input" type="text" data-bind="value:width" style="width:60px;"/>
        <span>h:</span>
		<input class="menu-input" type="text" data-bind="value:height" style="width:60px;"/>
		<button class="open-tool" data-bind="click:$.proxy(__open_map__,$root)">
            <i class="icon-folder-open"></i>
            Open
        </button>
		<button class="save-tool" data-bind="click:$.proxy(__save_map__,$root)">
            <i class="icon-folder-close"></i>
            Save
        </button>
	</div>
    
    <div id="map-container">
        <div id="map" data-bind="style: to_style">
            <!-- ko foreach:sprite_list().sort($root.__sort_draw__) -->
                <div class="map-item" data-bind="style: to_style(-1)"></div>
            <!-- /ko -->
        </div>
    </div>
	<div id="sprites" data-bind="css:{'shown':sprites_visible(),
									  'hidden':!sprites_visible()}">
		<table>
			<tbody  data-bind="foreach:sprite_list">
			<tr>
				<td data-bind="text:layer"></td>
				<td data-bind="text:sheet"></td>
				<td data-bind="text:map_loc"></td>
				<td data-bind="text:sheet_rect"></td>
			</tr>
			</tbody>
		</table>
	</div>
		
	<div id="sheets" data-bind="css:{'shown':sheets_visible(),
									 'hidden':!sheets_visible()}">
		<!-- ko if:selected_sheet -->
        <div id="spitesheetimg" class="spitesheetpanel" data-bind="style:selected_sheet().to_style"></div>
        <div id="spitesheetgrid" class="spitesheetpanel" data-bind="style:selected_sheet().to_size_style">
		<!-- ko foreach:selected_sheet().grid_list -->
			<div class="sheet-item" data-bind="style: to_style(-1),
											   click:$parent.selected_sprite_item,
											   clickBubble:false,
											   css:{selected_sprite:$data == $root.selected_sprite_item()}"></div>
		<!-- /ko -->
        </div>
		<!-- /ko -->
	</div>
    
    <div id="dropdown-layers" class="dropdown dropdown-tip dropdown-anchor-right">
        <ul class="dropdown-menu">
            <!-- ko foreach:layers -->
            <li><a href="#" data-bind="text:$data,click:$parent.selected_layer"></a></li>
            <!-- /ko -->
            <li class="dropdown-divider"></li>
            <li><a href="#" data-bind="click:$.proxy(__layer_dialog__,$root)">Edit Layers</a></li>
        </ul>
    </div>
    <div id="dropdown-sheets" class="dropdown dropdown-tip dropdown-anchor-right">
        <ul class="dropdown-menu" >
            <!-- ko foreach:sprite_sheets -->
            <li><a href="#" data-bind="text:sheet,click:$parent.selected_sheet"></a></li>
            <!-- /ko -->
            <li class="dropdown-divider"></li>
            <li><a href="#" data-bind="click:$.proxy(__upload_dialog__,$root)">Add Sheet</a></li>
        </ul>
    </div>
    
    <div class="sps-dialog-container">
        <div class="dialog">
            <div class="dialog-title">
                Upload Spritesheet...
            </div>
            <form class="dialog-content" 
                method="post" 
                action="/spritesheets" enctype="multipart/form-data">
                <input type="file" name="file1" />
                <div class="hr"></div>
                <div style="text-align:right;">
                    <button class="dialog-close">Cancel</button>
                    <button>Upload</button>
                </div>
            </form>
        </div>
    </div>
    <div class="mps-dialog-container">
        <div class="dialog">
            <div class="dialog-title">
                Save Map...
            </div>
            <form class="dialog-content" 
                method="post" 
                action="/maps" enctype="multipart/form-data">
                <label>name:</label>
                <input type="text" name="filename" placeholder="map name" />
                <div class="hr"></div>
                <div style="text-align:right;">
                    <button class="dialog-close">Cancel</button>
                    <button>Save</button>
                </div>
            </form>
        </div>
    </div>
    <div class="lyr-dialog-container">
        <div class="dialog">
            <div class="dialog-title">
                Sort &amp; Edit Layers...
            </div>
            <form class="dialog-content">
                <div>
                    <ul class="sortable-list" data-bind="foreach:edit_layers">
                        <li>
                            <button class="up-button sort-button" data-bind="click:$parent.up, disable:$parent.edit_layers().indexOf()==0"> <!--$parent.disableup($data)">-->
                                <i class='icon-caret-up'></i></button>
                            <button class="down-button sort-button" data-bind="click:$parent.down"> <!--, disable:$parent.disabledown($data)">-->
                                <i class='icon-caret-down'></i></button>
                            <input type="text" data-bind="value:title" />
                            <button class="delete-layer-button" data-bind="click:$parent.delete_item"> <!--, disable:$parent.disabledelete($data)">-->
                                <i class='icon-minus'></i></button>
                        </li>
                    </ul>
                </div>
                <hr/>
                <div style="text-align:right;">
                    <button class="dialog-close">Cancel</button>
                    <button>Apply</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>