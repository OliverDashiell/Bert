<!DOCTYPE html>
<html lang="en">
<head>
  <title>Map Editor</title>
  <link rel="stylesheet" type="text/css" href="css/html5reset-1.6.1.css" />
  <link rel="stylesheet" type="text/css" href="css/map_editor.css" />
  <script type="text/javascript" src="lib/jquery-2.0.2.min.js"></script>
  <script type="text/javascript" src="lib/knockout-2.2.1.js"></script>
  <script type="text/javascript" src="js/map_editor.js"></script>
  <script type="text/javascript">
$(function(){
	var appl = window.appl = new Appl();
	appl.sheets_visible = ko.observable(false);
	appl.sprites_visible = ko.observable(false);
	appl.add_sprite_sheet("default.png");
	
	$('.sheets-tool').click(function(){
		appl.sheets_visible(!appl.sheets_visible());
	});
	$('.sprites-tool').click(function(){
		appl.sprites_visible(!appl.sprites_visible());
	});
	$("#map").click(function(e){
		var $map = $("#map");
		var posX = e.pageX - $map.offset().left,
			posY = e.pageY - $map.offset().top;
		appl.do_action(posX, posY);
	});
	
	var $container = $('#sheets');
    var $selection = $('<div>').addClass('selection-box');
    
    $container.on('mousedown', function(e) {
    	if(e.target !== $container[0]) return;
    	
        var click_y = e.pageY,
	    	click_x = e.pageX,
	    	width = 0,
	    	height = 0;
      
        $selection.css({
          'top':    click_y - $container.offset().top,
          'left':   click_x - $container.offset().left,
          'width':  0,
          'height': 0
        });
        $selection.appendTo($container);
        
        $container.on('mousemove', function(e) {            
          var move_x = e.pageX,
              move_y = e.pageY,
              new_x, new_y;

		  width  = Math.abs(move_x - click_x),
		  height = Math.abs(move_y - click_y),
          
          new_x = (move_x < click_x) ? (click_x - width) : click_x;
          new_y = (move_y < click_y) ? (click_y - height) : click_y;
          
          $selection.css({
            'width': width,
            'height': height,
            'top': new_y - $container.offset().top,
            'left': new_x - $container.offset().left
          });
          
        }).on('mouseup', function(e) {
            $container.off('mousemove');
            appl.sheet_drag_rect([
            	parseInt(click_x - $container.offset().left,10),
            	parseInt(click_y - $container.offset().top,10),
            	parseInt(width,10),
            	parseInt(height,10)
            ]);
            //$selection.remove();
            console.log(appl.sheet_drag_rect());
        });
    });
    
    appl.__add_item__ = function(){
    	$selection.remove();
    	appl.add_spite_sheet_item();
    };
    
    appl.__remove_item__ = function(){
    	
    };
    
    appl.__sort_draw__ = function(l,r){
    	return l.layer() === r.layer() ? 0 : l.layer() > r.layer() ? 1 : -1;
    };
    
	ko.applyBindings(appl);
});  
  </script>
</head>
<body>
	<div id="menu">
		<button class="paint-tool" data-bind="css:{'active':selected_tool()=='paint'},click:$.proxy(selected_tool,$root,'paint')">paint</button>
		<button class="delete-tool" data-bind="css:{'active':selected_tool()=='delete'},click:$.proxy(selected_tool,$root,'delete')">delete</button>
		<button class="sheets-tool pull-right" data-bind="css:{'active':sheets_visible}">sheets</button>
		<button class="add-sheetitem-tool pull-right" data-bind="enable:sheet_drag_rect,click:__remove_item__">remove</button>
		<button class="add-sheetitem-tool pull-right" data-bind="enable:sheet_drag_rect,click:__add_item__">add</button>
		<button class="sprites-tool" data-bind="css:{'active':sprites_visible}">sprites</button>
		<span>x:<span data-bind="text:width"></span></span>
		<span>y:<span data-bind="text:height"></span></span>
		<span>s:<span data-bind="text:selected_sprite_item_index()"></span></span>
		<input type="text" data-bind="value:selected_layer" />
	</div>
	
	<div id="map">
		<!-- ko foreach:sprite_list -->
			<div class="sheet-item" data-bind="style: to_style()"></div>
		<!-- /ko -->
	</div>
	<div id="sprites" data-bind="css:{'shown':sprites_visible(),
									  'hidden':!sprites_visible()}">
		<h3>sprites</h3>
		<table>
			<tbody  data-bind="foreach:sprite_list">
			<tr>
				<td data-bind="text:layer"></td>
				<td data-bind="text:sheet"></td>
				<td data-bind="text:map_loc"></td>
				<td data-bind="text:sheet_rect"></td>
			</tr>
			</tbody>
		</table>
	</div>
		
	<div id="sheets" data-bind="css:{'shown':sheets_visible(),
									 'hidden':!sheets_visible()}">
		<h3>sheets</h3>
		<!-- ko if:selected_sheet -->
		<!-- ko foreach:selected_sheet().grid_list -->
			<div class="sheet-item" data-bind="style: to_style(),
											   click:$parent.selected_sprite_item,
											   clickBubble:false,
											   css:{selected_sprite:$data == $root.selected_sprite_item()}"></div>
		<!-- /ko -->
		<!-- /ko -->
	</div>
</body>
</html>